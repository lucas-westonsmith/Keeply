<div class="container my-5 items-index">
  <h1 class="page-title text-gradient angry-underline-blue">My items</h1>
  <p class="page-description">Explore all the items youâ€™ve added to your collection.</p>

  <%= link_to 'Add an item', new_item_path, class: 'btn btn-primary shiny-cta add-item-button' %>

  <% if @items.any? %>
    <!-- Section de tri et filtrage -->
    <div class="filter-sort-container">
      <div class="filter-sort-box">
        <form class="filter-sort-form" method="get">
          <!-- Sorting Options -->
          <div class="sort-options">
            <label for="sort">Sort by</label>
            <select name="sort" id="sort" class="form-select">
              <option value="" <%= params[:sort].blank? ? "selected" : "" %>>Select</option>
              <option value="price_asc" <%= params[:sort] == "price_asc" ? "selected" : "" %>>Price: low to high</option>
              <option value="price_desc" <%= params[:sort] == "price_desc" ? "selected" : "" %>>Price: high to low</option>
              <option value="newest_first" <%= params[:sort] == "newest_first" ? "selected" : "" %>>Newest first</option>
              <option value="oldest_first" <%= params[:sort] == "oldest_first" ? "selected" : "" %>>Oldest first</option>
            </select>
          </div>
          <!-- Filter by Issuer -->
          <div class="filter-options">
            <label for="issuer">Issuer</label>
            <select name="issuer" id="issuer" class="form-select">
              <option value="" <%= params[:issuer].blank? ? "selected" : "" %>>All Issuers</option>
                <% current_user.items.where.not(issuer: nil).distinct.pluck(:issuer).sort.each do |issuer| %>
                <option value="<%= issuer %>" <%= params[:issuer] == issuer ? "selected" : "" %>><%= issuer %></option>
              <% end %>
            </select>
          </div>

          <!-- Filter by Category -->
          <div class="filter-options">
            <label for="category">Category</label>
            <select name="category" id="category" class="form-select">
              <option value="" <%= params[:category].blank? ? "selected" : "" %>>All Categories</option>
                <% current_user.items.where.not(category: nil).distinct.pluck(:category).sort.each do |category| %>
                <option value="<%= category %>" <%= params[:category] == category ? "selected" : "" %>><%= category %></option>
              <% end %>
            </select>
          </div>

          <!-- Filter by Condition -->
          <div class="filter-options">
            <label for="condition">Condition</label>
            <select name="condition" id="condition" class="form-select">
              <option value="" <%= params[:condition].blank? ? "selected" : "" %>>All Conditions</option>
              <% current_user.items.distinct.pluck(:condition).compact.sort.each do |condition| %>
                <option value="<%= condition %>" <%= params[:condition] == condition ? "selected" : "" %>><%= condition.capitalize %></option>
              <% end %>
            </select>
          </div>

          <!-- Filter by List -->
          <div class="filter-options">
            <label for="list_id">List</label>
            <select name="list_id" id="list_id" class="form-select">
              <option value="" <%= params[:list_id].blank? ? "selected" : "" %>>All Lists</option>
              <% current_user.lists.joins(:items).distinct.order(title: :asc).each do |list| %>
                <option value="<%= list.id %>" <%= params[:list_id].to_i == list.id ? "selected" : "" %>><%= list.title %></option>
              <% end %>
            </select>
          </div>

          <!-- Buttons -->
          <div class="filter-sort-actions">
            <button type="submit" class="apply-button btn btn-secondary shiny-cta">Apply</button>
            <%= link_to 'Reset', items_path, class: 'btn-reset btn btn-reset' %>
          </div>
        </form>
      </div>
    </div>

    <!-- Liste des items -->
    <div class="items-list">
      <% @items.each do |item| %>
        <div class="item-card">
          <%= link_to item_path(item), class: "item-link" do %>
            <!-- Image -->
            <div class="item-image">
              <% item_photo_url = cloudinary_item_photo_url(item) %>

              <% if item_photo_url.present? %>
                <%= image_tag item_photo_url, alt: "Item photo", class: "item-photo" %>
              <% else %>
                <%= image_tag item.default_image, alt: "Default item photo", class: "item-photo" %>
              <% end %>
            </div>

            <!-- Title -->
            <div class="item-title">
              <h3>
                <%= truncate(item.title, length: 25, omission: "...") %>
              </h3>
            </div>

            <div class="item-details">
              <% if item.price.present? %>
                <p class="item-price"><strong>Price / Amount:</strong> <%= item.price %>â‚¬</p>
              <% end %>

              <% if item.issuer.present? %>
                <p class="item-issuer"><strong>Issuer:</strong> <%= item.issuer %></p>
              <% end %>

              <% if item.category.present? %>
                <p class="item-category"><strong>Category:</strong> <%= item.category %></p>
              <% end %>

              <% if item.condition.present? %>
                <p class="item-condition"><strong>Condition:</strong> <%= item.condition.capitalize %></p>
              <% end %>

              <% if item.lists.any? %>
                <p class="item-list">
                  <strong><%= item.lists.count > 1 ? "Lists" : "List" %>:</strong>
                  <%= item.lists.map { |list| link_to list.title, list_path(list), class: "list-link" }.join(", ").html_safe %>
                </p>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <!-- Message si aucun item -->
    <div class="no-items-message">
      <h3>ðŸ˜¢ Oops, it looks like your collection is empty!</h3>
      <p>Donâ€™t worry, itâ€™s easy to get started. Click the <strong>Add an item</strong> button above to begin creating your collection. ðŸŒŸ</p>
      <p>Weâ€™re excited to see your collection grow!</p>
    </div>
  <% end %>
</div>
