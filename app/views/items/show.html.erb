<div class="back-button">
  <%= link_to request.referer || root_path, class: "back-link" do %>
    <i class="back-arrow"></i>
    Back
  <% end %>
</div>

<div class="single-item-container">
  <!-- Titre de l'item -->
  <h1 class="single-item-title">
    <span class="angry-underline-blue"><%= @item.title %></span>
  </h1>

  <!-- Description de l'item -->
  <p class="single-item-description"><%= @item.description %></p>

  <!-- Boutons sous la description -->
  <div class="item-actions">
    <%= link_to 'Edit', edit_item_path(@item), class: 'btn btn-primary action-button' %>
    <%= link_to 'Delete', item_path(@item), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: 'btn btn-danger action-button' %>
  </div>

  <!-- Ligne grise pleine largeur -->
  <div class="full-width-divider"></div>

  <!-- Conteneur principal -->
  <div class="item-content-wrapper d-flex gap-4 mt-4">
    <!-- Colonne gauche : Informations -->
    <div class="item-info-cards">
      <% if @item.price.present? %>
        <div class="info-box">
          <p><strong>Price:</strong> <%= @item.price %>€</p>
        </div>
      <% end %>

      <% if @item.issuer.present? %>
        <div class="info-box">
          <p><strong>Issuer:</strong> <%= @item.issuer %></p>
        </div>
      <% end %>

    <% if @item.lists.any? %>
      <div class="info-box">
        <p>
          <strong><%= @item.lists.count > 1 ? "Lists:" : "List:" %></strong>
          <%= @item.lists.map { |list| link_to list.title, list_path(list), class: "list-link" }.join(", ").html_safe %>
        </p>
      </div>
    <% end %>

      <% if @item.category.present? %>
        <div class="info-box">
          <p><strong>Category:</strong> <%= @item.category %></p>
        </div>
      <% end %>

      <% if @item.purchase_date.present? %>
        <div class="info-box">
          <p><strong>Purchase Date:</strong> <%= @item.purchase_date %></p>
        </div>
      <% end %>

      <% if @item.warranty_expiry_date.present? %>
        <div class="info-box">
          <p><strong>Warranty Expiry Date:</strong> <%= @item.warranty_expiry_date %></p>
        </div>
      <% end %>
    </div>

    <!-- Colonne droite : Image et facture -->
 <div class="item-media">
  <div class="item-photo-container">
    <% if @item.photo.attached? %>
      <%= cl_image_tag @item.photo.key, alt: "Photo of #{@item.title}", class: "item-photo" %>
    <% else %>
      <%= image_tag @item.default_image, alt: "Default item photo", class: "item-photo" %>
    <% end %>
  </div>

  <% if @item.invoice.attached? %>
    <div class="invoice-preview">
      <p><strong>Invoice:</strong></p>

      <!-- Lien de téléchargement -->
      <%= link_to 'Download Invoice', rails_blob_url(@item.invoice, disposition: "attachment"), target: "_blank", class: 'invoice-link' %>

      <!-- TESTER SI L'URL FONCTIONNE -->
      <p><%= link_to "Test PDF", rails_blob_url(@item.invoice, disposition: "inline"), target: "_blank" %></p>

      <% if @item.invoice.blob.content_type == 'application/pdf' %>
        <% if Rails.application.config.active_storage.service == :cloudinary %>
          <!-- Cloudinary ne supporte pas l'iframe pour les PDFs, donc on affiche un lien -->
          <%= link_to 'View Invoice', url_for(@item.invoice), target: "_blank", class: 'invoice-link' %>
        <% else %>
          <!-- Pour les PDFs en stockage local, on utilise un iframe -->
          <iframe src="<%= rails_blob_url(@item.invoice, disposition: "inline") %>" class="invoice-iframe" width="100%" height="500px"></iframe>
        <% end %>
      <% elsif @item.invoice.blob.content_type.start_with?('image/') %>
        <%= cl_image_tag @item.invoice.key, alt: "Invoice preview", class: "invoice-image" %>
      <% end %>
    </div>
  <% else %>
    <p><strong>Invoice:</strong> No invoice uploaded.</p>
  <% end %>
</div>


  </div>
</div>
