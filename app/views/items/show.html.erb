<div class="back-button">
  <%= link_to request.referer || root_path, class: "back-link" do %>
    <i class="back-arrow"></i>
    Back
  <% end %>
</div>

<div class="single-item-container">
  <!-- Titre de l'item -->
  <h1 class="single-item-title">
    <span class="angry-underline-blue"><%= @item.title %></span>
  </h1>

  <!-- Description de l'item -->
  <p class="single-item-description"><%= @item.description %></p>

  <!-- Boutons sous la description -->
  <div class="item-actions">
    <%= link_to 'Edit', edit_item_path(@item), class: 'btn btn-primary action-button' %>
    <%= link_to 'Delete', item_path(@item), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: 'btn btn-danger action-button' %>
  </div>

  <!-- Ligne grise pleine largeur -->
  <div class="full-width-divider"></div>

  <!-- Conteneur principal -->
  <div class="item-content-wrapper d-flex gap-4 mt-4">
    <!-- Colonne gauche : Informations -->
    <div class="item-info-cards">
      <% if @item.price.present? %>
        <div class="info-box">
          <p><strong>Price:</strong> <%= @item.price %>€</p>
        </div>
      <% end %>

      <% if @item.issuer.present? %>
        <div class="info-box">
          <p><strong>Issuer:</strong> <%= @item.issuer %></p>
        </div>
      <% end %>

      <% if @item.lists.any? %>
        <div class="info-box">
          <p>
            <strong><%= @item.lists.count > 1 ? "Lists:" : "List:" %></strong>
            <%= @item.lists.map { |list| link_to list.title, list_path(list), class: "list-link" }.join(", ").html_safe %>
          </p>
        </div>
      <% end %>

      <% if @item.category.present? %>
        <div class="info-box">
          <p><strong>Category:</strong> <%= @item.category %></p>
        </div>
      <% end %>

      <% if @item.condition.present? %>
        <div class="info-box">
          <p><strong>Condition:</strong> <%= @item.condition.capitalize %></p>
        </div>
      <% end %>

      <% if @item.purchase_date.present? %>
        <div class="info-box">
          <p><strong>Purchase Date:</strong> <%= @item.purchase_date %></p>
        </div>
      <% end %>

      <% if @item.warranty_expiry_date.present? %>
        <div class="info-box">
          <p>
            <strong>Warranty Expiry Date:</strong>
            <%= @item.warranty_expiry_date %>
            <% if @item.warranty_expiry_date < Date.today %>
              <span class="expired-text"> (EXPIRED) </span>
            <% end %>
          </p>
        </div>
      <% end %>

    </div>

    <!-- Colonne droite : Image et facture -->
    <div class="item-media">
      <div class="item-photo-container">
        <% item_photo_url = cloudinary_item_photo_url(@item) %>

        <% if item_photo_url.present? %>
          <%= image_tag item_photo_url, alt: "Photo of #{@item.title}", class: "item-photo" %>
        <% else %>
          <%= image_tag @item.default_image, alt: "Default item photo", class: "item-photo" %>
        <% end %>
      </div>

      <% if @item.invoice.attached? %>
        <div class="invoice-preview">
          <!-- ✅ Récupération correcte de l'URL Cloudinary -->
          <% invoice_url = cloudinary_invoice_url(@item) %>

          <% if invoice_url.present? %>
            <!-- ✅ Lien de téléchargement avec espacement -->
            <div class="download-section">
              <%= link_to 'Download Invoice', invoice_url, target: "_blank", class: 'invoice-link' %>
            </div>

            <!-- ✅ Prévisualisation -->
            <div class="invoice-preview-container">
              <% pdf_preview_url = invoice_url.sub('.pdf', '.jpg') + "?pg=1&w=700" %>
              <img id="invoice-preview-image" src="<%= pdf_preview_url %>" class="invoice-preview-image" alt="Invoice Image">

              <!-- ✅ Miniatures affichées uniquement si plusieurs pages -->
              <% total_pages = @item.invoice.blob.metadata["pages"].to_i %>
              <% if total_pages > 1 %>
                <div class="invoice-pages">
                  <% (1..total_pages).each do |page| %>
                    <% page_url = invoice_url.sub('.pdf', '.jpg') + "?pg=#{page}&w=100" %>
                    <img src="<%= page_url %>" class="invoice-page-thumb" alt="Invoice Page <%= page %>" onclick="updatePreview('<%= page_url %>')">
                  <% end %>
                </div>
              <% end %>
            </div>
          <% else %>
            <p><strong>Invoice:</strong> Error loading file.</p>
          <% end %>
        </div>
      <% else %>
        <p><strong>Invoice:</strong> No invoice uploaded.</p>
      <% end %>
    </div>
  </div>
</div>

<!-- ✅ Script pour changer la prévisualisation -->
<script>
  function updatePreview(url) {
    document.getElementById('invoice-preview-image').src = url;
  }
</script>
